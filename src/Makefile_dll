# Native build (Linux/macOS: .so, Windows/MinGW: .dll)
CXX ?= g++
EXE ?= libffish.so
IMPLIB :=
OS_NAME := $(OS)
ifeq ($(OS_NAME),)
  OS_NAME := $(shell uname -s)
endif
ifneq (,$(findstring MINGW,$(OS_NAME)))
  EXE := ffish.dll
  IMPLIB := libffish.dll.a
endif
ifeq ($(OS_NAME),Windows_NT)
  EXE := ffish.dll
  IMPLIB := libffish.dll.a
endif

SRCS = ffishdll.cpp benchmark.cpp bitbase.cpp bitboard.cpp endgame.cpp evaluate.cpp \
	material.cpp misc.cpp movegen.cpp movepick.cpp pawns.cpp position.cpp psqt.cpp \
	search.cpp thread.cpp timeman.cpp tt.cpp uci.cpp ucioption.cpp tune.cpp syzygy/tbprobe.cpp \
	nnue/evaluate_nnue.cpp nnue/features/half_ka_v2.cpp \
	partner.cpp parser.cpp piece.cpp variant.cpp xboard.cpp \
	nnue/features/half_ka_v2_variants.cpp

OBJS := $(SRCS:.cpp=.o)

CXXFLAGS ?= -std=c++17 -O3 -Wall -Wextra -DNDEBUG -DLARGEBOARDS -DPRECOMPUTED_MAGICS -DALLVARS -DNNUE_EMBEDDING_OFF
LDFLAGS ?= -shared
ifneq (,$(filter $(OS_NAME),Linux Darwin))
  CXXFLAGS += -fPIC -pthread
endif
ifneq ($(IMPLIB),)
  LDFLAGS += -Wl,--out-implib,$(IMPLIB)
endif

all: $(EXE)

$(EXE): $(OBJS)
	$(CXX) $(LDFLAGS) -o $@ $(OBJS)

%.o: %.cpp
	$(CXX) $(CXXFLAGS) -c $< -o $@

clean:
	rm -f $(OBJS) $(EXE) $(IMPLIB)
